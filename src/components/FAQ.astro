---
import { getCollection } from 'astro:content';

// Default FAQs (fallback if no content in CMS)
const defaultFaqs: Array<{question: string; answer: string; order?: number}> = [];

// Try to get FAQs from content collection
let faqs = defaultFaqs;
try {
  const faqEntries = await getCollection('faq');
  if (faqEntries.length > 0) {
    faqs = faqEntries
      .map(entry => ({
        question: entry.data.question,
        answer: entry.data.answer,
        order: entry.data.order || 0,
      }))
      .sort((a, b) => a.order - b.order);
  }
} catch (e) {
  // Use default FAQs if collection fails
}
---

<section id="faq" class="section-padding">
  <div class="container-custom">
    <!-- Section header -->
    <div class="text-center mb-16">
      <span class="text-[var(--accent)] font-medium text-sm uppercase tracking-wider">FAQ</span>
      <h2 class="section-title mt-2">Często zadawane pytania</h2>
      <p class="section-subtitle">
        Znajdź odpowiedzi na najczęściej zadawane pytania.
      </p>
    </div>

    <!-- FAQ accordion -->
    <div class="max-w-3xl mx-auto space-y-4">
      {
        faqs.map((faq, index) => (
          <div class="card faq-item" data-faq-index={index}>
            <button
              type="button"
              class="faq-trigger w-full flex items-center justify-between text-left gap-4"
              aria-expanded="false"
            >
              <span class="font-semibold">{faq.question}</span>
              <span class="faq-icon flex-shrink-0 w-6 h-6 rounded-full bg-[var(--accent)]/10 flex items-center justify-center transition-transform duration-300">
                <svg class="w-4 h-4 text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" />
                </svg>
              </span>
            </button>
            <div class="faq-content overflow-hidden transition-all duration-300" style="max-height: 0;">
              <p class="pt-4 text-[var(--text-secondary)]">{faq.answer}</p>
            </div>
          </div>
        ))
      }
    </div>

    <!-- Contact CTA -->
    <div class="text-center mt-12">
      <p class="text-[var(--text-secondary)] mb-4">Nie znalazłeś odpowiedzi na swoje pytanie?</p>
      <a href="/kontakt" class="btn-primary">
        Skontaktuj się z nami
      </a>
    </div>
  </div>
</section>

<script>
  function initFAQ() {
    const faqItems = document.querySelectorAll('.faq-item');

    faqItems.forEach((item) => {
      const trigger = item.querySelector('.faq-trigger');
      const content = item.querySelector('.faq-content') as HTMLElement;
      const icon = item.querySelector('.faq-icon');

      trigger?.addEventListener('click', () => {
        const isOpen = trigger.getAttribute('aria-expanded') === 'true';

        // Close all other items
        faqItems.forEach((otherItem) => {
          if (otherItem !== item) {
            const otherTrigger = otherItem.querySelector('.faq-trigger');
            const otherContent = otherItem.querySelector('.faq-content') as HTMLElement;
            const otherIcon = otherItem.querySelector('.faq-icon');

            otherTrigger?.setAttribute('aria-expanded', 'false');
            if (otherContent) otherContent.style.maxHeight = '0';
            otherIcon?.classList.remove('rotate-45');
          }
        });

        // Toggle current item
        if (isOpen) {
          trigger.setAttribute('aria-expanded', 'false');
          if (content) content.style.maxHeight = '0';
          icon?.classList.remove('rotate-45');
        } else {
          trigger.setAttribute('aria-expanded', 'true');
          if (content) content.style.maxHeight = content.scrollHeight + 'px';
          icon?.classList.add('rotate-45');
        }
      });
    });
  }

  // Run on initial load
  initFAQ();

  // Re-run on Astro page transitions
  document.addEventListener('astro:after-swap', initFAQ);
</script>

<style>
  .faq-icon.rotate-45 {
    transform: rotate(45deg);
  }
</style>
